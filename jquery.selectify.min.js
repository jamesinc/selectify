/**
 * Selectify - an unobtrusive select overlay that reproduces the
 * native <select> element experience Pretty Well(TM).
 * 
 * by James Ducker <james.ducker+js@gmail.com>
 * 
 * Works with jQuery >= 1.7
 *
 * "Add-and-forget" - manipulate your underlying <select> element
 * and changes are immediately propagated to Selectify's overlay.
 *
 * Project home: https://github.com/jamesinc/selectify
 * Issue tracker: https://github.com/jamesinc/selectify/issues
 */

(function($){"use strict";var defaults={duration:50,autoWidth:!0,btnText:"â–¼",classes:{container:"sl-container",placeholderContainer:"sl-placeholder-container",placeholder:"sl-placeholder",btn:"sl-button",options:"sl-options",selected:"sl-selected",open:"sl-open"}};$.fn.selectify=function(options){var settings,remove="remove"===options,Dictionary=function(select){var optionsHtml="",searchString="",searchTimer=null,dict={},clearSearchString=function(){searchString=""},rebuild=function(){select.html()!==optionsHtml&&($.each(select.find("option"),function(){var el=$(this);el.text().length&&(dict[el.text()]=el.val())}),optionsHtml=select.html())},resetSearch=function(){clearTimeout(searchTimer),searchTimer=setTimeout(clearSearchString,1e3)};return{find:function(text){var textLength,selectedOption=$(select.find("option").get(select.get(0).selectedIndex)),result=!1;return rebuild(),resetSearch(),searchString+=text,textLength=searchString.length,selectedOption.length&&selectedOption.text().substr(0,textLength).toUpperCase()===searchString||textLength&&$.each(dict,function(key,value){return key.substr(0,textLength).toUpperCase()===searchString?(result=value,!1):void 0}),result},clear:function(){clearTimeout(searchTimer),clearSearchString()}}};return options=options||{},settings=$.extend(!0,{},defaults,options),this.each(function(){var options,container,placeholderContainer,placeholder,btn,list,anchors,el=$(this),dict=new Dictionary(el),self=this;if(el.is("select")){if(el.data("sl")===!0&&(el.next("."+settings.classes.container).remove(),remove))return el.css("display",""),void 0;options=el.find("option"),container=$("<div/>",{"class":settings.classes.container,css:{position:"relative"}}),placeholderContainer=$("<div/>",{"class":settings.classes.placeholderContainer,tabindex:0}),placeholder=$("<div/>",{"class":settings.classes.placeholder}),btn=$("<div />",{"class":settings.classes.btn,text:settings.btnText,css:{position:"absolute",right:0,top:0,height:"100%"}}),placeholderContainer.append(placeholder,btn),list=$("<ul/>",{"class":settings.classes.options,css:{position:"absolute",left:0}}),options.each(function(){var self=$(this),a=$("<a/>",{href:"#",text:self.text(),css:{"white-space":"nowrap"},click:function(e){e.preventDefault(),el.val()!==self.val()&&(placeholder.text(self.text()),list.find("a").removeClass(settings.classes.selected),a.addClass(settings.classes.selected),el.val(self.val()).trigger("change",[{sl:!0}])),list.slideUp(settings.duration),container.removeClass(settings.classes.open)}}),li=$("<li/>");li.append(a),list.append(li)}),placeholderContainer.on("click",function(e){e.preventDefault(),list.slideToggle(settings.duration),container.toggleClass(settings.classes.open),el.trigger("change")}),placeholderContainer.on("keydown",function(e){var match,key=e.which,keyChar=String.fromCharCode(key),intercept=!1,currentIndex=self.selectedIndex;return(40===key||39===key)&&(intercept=!0,self.selectedIndex=Math.min(options.length-1,self.selectedIndex+1)),(38===key||37===key)&&(intercept=!0,self.selectedIndex=Math.max(0,self.selectedIndex-1)),intercept?(e.preventDefault(),currentIndex!==self.selectedIndex&&(dict.clear(),el.trigger("change")),!1):((13===key||32===key)&&list.slideUp(settings.duration),/[a-zA-Z0-9-_ !@#$%^&*\(\)+\/\\?><;:'"|]/.test(keyChar)&&(match=dict.find(keyChar),match&&el.val()!==match&&el.val(match).trigger("change")),void 0)}),placeholderContainer.on("selectstart",function(){return!1}),$(document).on("mouseup",function(e){container.has(e.target).length||(list.slideUp(settings.duration),container.removeClass(settings.classes.open))}),el.on("change",function(e,src){var index=this.selectedIndex,listScrollOffset=Math.abs(list.scrollTop()),selectedAnchor=$(anchors.get(index)),positionOffset=parseInt(list.css("border-top-width"),10),selectionOffset=selectedAnchor.offset().top-anchors.first().offset().top;listScrollOffset>selectionOffset?list.clearQueue().animate({scrollTop:positionOffset+selectionOffset},settings.duration):selectionOffset>listScrollOffset+list.height()-selectedAnchor.outerHeight()&&list.clearQueue().animate({scrollTop:positionOffset+selectionOffset-list.height()+selectedAnchor.outerHeight()},settings.duration),src&&src.sl||(placeholder.text($(options.get(index)).text()),anchors.removeClass(settings.classes.selected),selectedAnchor.addClass(settings.classes.selected))}),anchors=list.find("a"),placeholder.text($(options.get(el[0].selectedIndex)).text()),$(anchors.get(el[0].selectedIndex)).addClass(settings.classes.selected),settings.autoWidth&&placeholder.width(el.width()),container.append(placeholderContainer,list),el.hide().after(container).data("sl",!0),list.hide().css("top",container.outerHeight())}}),this}})(jQuery);